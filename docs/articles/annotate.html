<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Annotate query spectra â€¢ MS2ID</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Annotate query spectra">
<meta property="og:description" content="MS2ID">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MS2ID</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/MS2ID.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/annotate.html">Annotate query spectra</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jmbadia/MS2ID/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="annotate_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Annotate query spectra</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jmbadia/MS2ID/blob/master/vignettes/annotate.Rmd"><code>vignettes/annotate.Rmd</code></a></small>
      <div class="hidden name"><code>annotate.Rmd</code></div>

    </div>

    
    
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><p><strong>Authors</strong>: Josep M. Badia [aut, cre] (<a href="https://orcid.org/0000-0002-5704-1124" class="uri">https://orcid.org/0000-0002-5704-1124</a>)<br><strong>Last modified:</strong> 2021-12-03 16:51:03<br><strong>Compiled</strong>: Fri Dec 10 14:21:24 2021</p>
<p>*This vignette describe in detail the <code>annotate</code> function. It is advised a previous reading of the <a href="MS2ID.html">MS2ID introduction</a>.</p>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p><code>annotate</code> is the MS2ID function that annotates MS/MS query spectra; every query spectrum is compared with a reference library, and compounds with a similar spectrum are listed. This function requires an MS2ID reference library, as described in <a href="MS2ID.html">MS2ID introduction</a>; here we will use the sample attached to MS2ID:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Decompress the MS2ID library that comes with MS2ID</span>
<span class="va">MS2IDzipFile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/MS2IDLibrary.zip"</span>, package <span class="op">=</span> <span class="st">"MS2ID"</span>,
                            mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">utils</span><span class="op">)</span>
<span class="va">MS2IDdirectory</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html">dirname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/unzip.html">unzip</a></span><span class="op">(</span><span class="va">MS2IDzipFile</span>, exdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></code></pre></div>
<p>The following example shows the basic usage of the function <code>annotate.</code>. Query spectra is provided pointing out the folder that contains the mzML files.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">utils</span><span class="op">)</span>
<span class="va">queryFile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/QRYspectra.zip"</span>, package <span class="op">=</span> <span class="st">"MS2ID"</span><span class="op">)</span>
<span class="va">queryFolder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"QRYspectra"</span><span class="op">)</span>
<span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/unzip.html">unzip</a></span><span class="op">(</span><span class="va">queryFile</span>, exdir <span class="op">=</span> <span class="va">queryFolder</span><span class="op">)</span>
<span class="co">#create the MS2ID object and annotate</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jmbadia.github.io/MS2ID/index.html">MS2ID</a></span><span class="op">)</span>
<span class="va">MS2IDobj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MS2ID.html">MS2ID</a></span><span class="op">(</span><span class="va">MS2IDdirectory</span><span class="op">)</span>
<span class="va">annotResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/annotate.html">annotate</a></span><span class="op">(</span>QRYdata <span class="op">=</span> <span class="va">queryFolder</span>, MS2ID <span class="op">=</span> <span class="va">MS2IDobj</span><span class="op">)</span></code></pre></div>
<p>Optionally, query spectra can also be provided under the form of an spectra object <span class="citation">(Gatto, Rainer, and Gibb 2021)</span>. That facilitates the use of tools developed in the <em><a href="https://bioconductor.org/packages/3.14/Spectra">Spectra</a></em> package to subset query spectra according to their retention time and MSLevel.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra">Spectra</a></span><span class="op">)</span>
<span class="va">querySpectra</span> <span class="op">&lt;-</span> <span class="fu">Spectra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html">Spectra</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="va">queryFolder</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="va">querySpectra</span> <span class="op">&lt;-</span> <span class="va">querySpectra</span> <span class="op">%&gt;%</span>
  <span class="fu">Spectra</span><span class="fu">::</span><span class="fu">filterMsLevel</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">Spectra</span><span class="fu">::</span><span class="fu">filterRt</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">400</span><span class="op">)</span><span class="op">)</span>
<span class="co">#annotate</span>
<span class="va">annotResult</span> <span class="op">&lt;-</span> <span class="fu">MS2ID</span><span class="fu">::</span><span class="fu"><a href="../reference/annotate.html">annotate</a></span><span class="op">(</span>QRYdata <span class="op">=</span> <span class="va">querySpectra</span>, MS2ID <span class="op">=</span> <span class="va">MS2IDobj</span><span class="op">)</span></code></pre></div>
<p>The <code>annotate</code> function returns an <code>Annot</code> object.</p>
</div>
<div id="annot" class="section level2">
<h2 class="hasAnchor">
<a href="#annot" class="anchor"></a>Annot object</h2>
<p>This object stores the annotation so we can:</p>
<ul>
<li>Browse graphically the results with the <code>MS2IDgui</code> function.</li>
<li>Export all the data as an xlsx file by using the <code>export2xlsx</code> function.</li>
<li>Extract any content by using the following <em>getters</em> (custom functions to <em>get</em> the info).
<ul>
<li>
<code>hits()</code>: Returns a cross-reference data frame containing the annotation hits, the id of the spectra and compounds and:
<ul>
<li>
<em>propAdduct</em>: the proposed adduct that would match the query precursor mass with the neutral mass of the reference compound.</li>
<li>
<em>cmnMasses</em>: Number of fragments in common between the query and the reference spectrum</li>
</ul>
</li>
<li>
<code>qrySpectra()</code>: returns an <code>Spectra</code> object (<em><a href="https://bioconductor.org/packages/3.14/Spectra">Spectra</a></em> package) containing both successful query and consensus spectra (and their source spectra) (see <a href="#consensus">consensus spectra</a>).</li>
<li>
<code>refSpectra()</code>: returns an <code>Spectra</code> object (<em><a href="https://bioconductor.org/packages/3.14/Spectra">Spectra</a></em> package) with the reference spectra present in the <em>hits</em> table.</li>
<li>
<code>refCompound()</code>: returns a data frame containing metadata of the reference compounds present in the <em>hits</em> table.</li>
<li>
<code>infoAnnotation()</code>: variables used on the <code>annotate</code> function.</li>
</ul>
</li>
</ul>
<p>In the example below, we use <em><a href="https://bioconductor.org/packages/3.14/Spectra">Spectra</a></em> tools to browse the annotation results, although it is more advisable to use the visual browsing provided by the <code>MS2IDgui</code> function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#merge hits and compound info</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">hits</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu">refCompound</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span>, 
                by.x <span class="op">=</span> <span class="st">"idREFcomp"</span>, by.y <span class="op">=</span> <span class="st">"id"</span>, all.y <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></code></pre></div>
<pre><code>##   idREFcomp    cosine idREFspect idQRYspect propAdduct cmnMasses ID_db
## 1         1 0.9325190         32       2251        M+H         3  MoNA
## 2         1 0.8549925         29       2298        M+H         3  MoNA
## 3         1 0.9317047         29       2251        M+H         2  MoNA
## 4         1 0.9681738         30       2330        M+H         3  MoNA
## 5         1 0.9116125         33       2298        M+H         4  MoNA
## 6         1 0.8966585         35       2298        M+H         3  MoNA
##        name    formula exactmass                    inchikey smiles
## 1 Bilirubin C33H36N4O6  584.2635 BPYKTIZUTYGOLE-IFADSCNNSA-N     NA
## 2 Bilirubin C33H36N4O6  584.2635 BPYKTIZUTYGOLE-IFADSCNNSA-N     NA
## 3 Bilirubin C33H36N4O6  584.2635 BPYKTIZUTYGOLE-IFADSCNNSA-N     NA
## 4 Bilirubin C33H36N4O6  584.2635 BPYKTIZUTYGOLE-IFADSCNNSA-N     NA
## 5 Bilirubin C33H36N4O6  584.2635 BPYKTIZUTYGOLE-IFADSCNNSA-N     NA
## 6 Bilirubin C33H36N4O6  584.2635 BPYKTIZUTYGOLE-IFADSCNNSA-N     NA</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra">Spectra</a></span><span class="op">)</span>
<span class="co">#Subset spectra and metadata considering first hit query spectra</span>
<span class="va">idQRYspect_1</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">idQRYspect</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="va">result_1</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">result</span>, <span class="va">idQRYspect</span>  <span class="op">==</span> <span class="va">idQRYspect_1</span><span class="op">)</span>
<span class="va">qrySpct_1</span> <span class="op">&lt;-</span> <span class="fu">qrySpectra</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span>
<span class="va">qrySpct_1</span> <span class="op">&lt;-</span> <span class="va">qrySpct_1</span><span class="op">[</span><span class="va">qrySpct_1</span><span class="op">$</span><span class="va">id</span> <span class="op">%in%</span> <span class="va">result_1</span><span class="op">$</span><span class="va">idQRYspect</span><span class="op">]</span>
<span class="va">refSpct_1</span> <span class="op">&lt;-</span> <span class="fu">refSpectra</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span>
<span class="va">refSpct_1</span> <span class="op">&lt;-</span> <span class="va">refSpct_1</span><span class="op">[</span><span class="va">refSpct_1</span><span class="op">$</span><span class="va">id</span> <span class="op">%in%</span> <span class="va">result_1</span><span class="op">$</span><span class="va">idREFspect</span><span class="op">]</span>
<span class="co">#compare query spectrum with its first hit reference spectrum</span>
<span class="va">refSpct_draw</span> <span class="op">&lt;-</span> <span class="va">refSpct_1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="va">refSpct_draw</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="va">refSpct_draw</span><span class="op">$</span><span class="va">intensity</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">refSpct_draw</span><span class="op">$</span><span class="va">intensity</span><span class="op">)</span>
<span class="va">qrySpct_1</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="va">qrySpct_1</span><span class="op">$</span><span class="va">intensity</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">qrySpct_1</span><span class="op">$</span><span class="va">intensity</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html">plotSpectraMirror</a></span><span class="op">(</span><span class="va">qrySpct_1</span>, <span class="va">refSpct_draw</span><span class="op">)</span></code></pre></div>
</div>
<div id="consensus" class="section level2">
<h2 class="hasAnchor">
<a href="#consensus" class="anchor"></a>Consensus spectra</h2>
<p>As a default, <code>annotate</code> function tries to summarize adjacent MS/MS spectra into consensus spectra: the resulting consensus spectra will be annotated instead of the query spectra that summarizes (along with the query spectra non able to be consensued). This strategy diminishes artifacts and noise and reduce significantly the annotation time.<br>
A group of <strong>adjacent</strong> query spectra is considered <em>source</em> for a consensus spectrum when all of them have the same precursor mass, collision energy and polarity. Also, every query spectrum must be similar (cosine &gt; <code>consCos</code> argument) to the apex spectrum of the group. The resulting consensus spectrum will be formed by the fragments present in the majority of the source query spectra (ratio determined by the <code>consComm</code> argument).<br>
The final <code>annot</code> object will contain not only the query spectra and the consensus spectra that succeeded in the annotation (i.e.Â with hits), but also the query spectra used to form the successful consensus spectra. Although it is recommended to use the MS2IDgui feature to elucidate the nature of the query spectra, it is also possible to check it by analyzing some of the variables contained in the <code>annot</code> object.</p>
<ul>
<li>When the spectrum is a consensus spectrum, <em>spectrumId_CONS</em> and <em>rtime_CONS</em> variables show the id and the retention time of its source query spectra.</li>
<li>
<em>rol</em> is an integer that makes explicit the nature of the spectrum:
<ul>
<li>1: query spectrum not grouped so it does not form consensus.<br>
</li>
<li>2: query spectrum grouped but not similar to the apex spectrum; it does not form consensus.<br>
</li>
<li>3: query spectrum source for a consensus spectrum.<br>
</li>
<li>4: consensus spectrum.</li>
</ul>
</li>
</ul>
<p>The algorithm will not annotate the spectra with rol=3.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">qrySpct</span> <span class="op">&lt;-</span> <span class="fu">qrySpectra</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span>
<span class="co">#shor query data concerning consensus formation</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">Spectra</span><span class="fu">::</span><span class="fu">spectraData</span><span class="op">(</span><span class="va">qrySpct</span>, 
                          <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"spectrumId_CONS"</span>, <span class="st">"rtime_CONS"</span>, <span class="st">"rol"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="subsetting-the-reference-library" class="section level2">
<h2 class="hasAnchor">
<a href="#subsetting-the-reference-library" class="anchor"></a>Subsetting the reference library</h2>
<p>In annotation, subsetting the reference library not only reduces the computing time significantly -by taking advantage of the MS2ID backend and the fragments index: it also prunes the result and cuts off non-sense hits. For example, the <code>cmnFrags = c(m, n)</code> argument limits the reference spectra so that reference spectra and query spectra have at least m peaks in common among their top n most intense peaks.<br>
In addition, the <code>cmnPrecMass</code> argument limits the reference spectra to those with the precursor mass of the query spectrum. On the other hand, <code>cmnNeutralMass</code> limits reference spectra to those with a neutral mass plausible with the query precursor (considering all possible adducts).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">annotResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/annotate.html">annotate</a></span><span class="op">(</span>QRYdata <span class="op">=</span> <span class="va">queryFolder</span>, MS2ID <span class="op">=</span> <span class="va">MS2IDobj</span>, 
                        cmnFrags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span>,
                        cmnPrecMass <span class="op">=</span> <span class="cn">TRUE</span>, cmnNeutralMass <span class="op">=</span> <span class="cn">TRUE</span>, 
                        cmnPolarity <span class="op">=</span> <span class="cn">TRUE</span>, predicted <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Other arguments subset the reference spectra according its experimental nature or the query spectrum polarization (<code>predicted</code> and <code>cmnPolarity</code>, respectively).</p>
</div>
<div id="annotation-with-different-metrics" class="section level2">
<h2 class="hasAnchor">
<a href="#annotation-with-different-metrics" class="anchor"></a>Annotation with different metrics</h2>
<p>As a default, the annotate function uses cosine similarity as a metric to compare two spectra; its default threshold value to beat to consider the comparison a hit is 0.8.<br>
The function also allows the simultaneous calculation of different metrics. In that case, a spectrum comparison is considered a hit when at least one of the metrics fulfills its threshold value. <strong>Note that <em>to fulfill</em> a threshold value has a different meaning depending on the metric</strong>: <em>topsoe</em> and <em>squared_chord</em> metrics return a lower number when the spectra are more similar so, unlike the rest, a hit will occur when the returned value is lower than its threshold.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">annotResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/annotate.html">annotate</a></span><span class="op">(</span>QRYdata <span class="op">=</span> <span class="va">queryFolder</span>, MS2ID <span class="op">=</span> <span class="va">MS2IDobj</span>,
                        metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fidelity"</span>, <span class="st">"cosine"</span>, <span class="st">"topsoe"</span><span class="op">)</span>,
                        metricsThresh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.8</span>, <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">MS2ID</span><span class="fu">::</span><span class="fu">hits</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##         fidelity    cosine     topsoe idREFspect idQRYspect idREFcomp
## 2236.1 0.6182551 0.2691026 0.68745142        170       2236        10
## 2236.2 0.9486782 0.9867201 0.08079319        173       2236        10
## 2236.3 0.9750072 0.9981363 0.03686771        174       2236        10
## 2236.4 0.9849112 0.9994530 0.02179557        175       2236        10
## 2236.5 0.9070347 0.9408979 0.16563675        176       2236        10
## 2236.6 0.7294529 0.5787374 0.48779452        177       2236        10
##        propAdduct cmnMasses
## 2236.1        M+H         6
## 2236.2        M+H         4
## 2236.3        M+H         3
## 2236.4        M+H         5
## 2236.5        M+H         5
## 2236.6        M+H         5</code></pre>
<p>Moreover, <strong>the user can define its own metric</strong> by declaring a function as an argument; in the following example, <code>foo</code> function uses cosine+1 as a distance metric.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">foo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">finalMatrix</span><span class="op">)</span><span class="op">{</span>
  <span class="va">vector1</span> <span class="op">&lt;-</span> <span class="va">finalMatrix</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>
  <span class="va">vector2</span> <span class="op">&lt;-</span> <span class="va">finalMatrix</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span>
  <span class="va">CosplusOne</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span>
    <span class="fu">philentropy</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/philentropy/man/distance.html">distance</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">vector1</span>, <span class="va">vector2</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"cosine"</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">CosplusOne</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"CosplusOne"</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">CosplusOne</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">annotResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/annotate.html">annotate</a></span><span class="op">(</span>QRYdata <span class="op">=</span> <span class="va">queryFolder</span>, MS2ID <span class="op">=</span> <span class="va">MS2IDobj</span>,
                        metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cosine"</span><span class="op">)</span>, metricsThresh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span>,
                        metricFUN <span class="op">=</span> <span class="va">foo</span>, metricFUNThresh <span class="op">=</span> <span class="fl">1.8</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">MS2ID</span><span class="fu">::</span><span class="fu">hits</span><span class="op">(</span><span class="va">annotResult</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##            cosine metricFunc.CosplusOne idREFspect idQRYspect idREFcomp
## 2236.2  0.9867201              1.986720        173       2236        10
## 2236.3  0.9981363              1.998136        174       2236        10
## 2236.4  0.9994530              1.999453        175       2236        10
## 2236.5  0.9408979              1.940898        176       2236        10
## 2236.9  0.9972315              1.997231        180       2236        10
## 2236.10 0.9994336              1.999434        181       2236        10
##         propAdduct cmnMasses
## 2236.2         M+H         4
## 2236.3         M+H         3
## 2236.4         M+H         5
## 2236.5         M+H         5
## 2236.9         M+H         2
## 2236.10        M+H         5</code></pre>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Spectra" class="csl-entry">
Gatto, Laurent, Johannes Rainer, and Sebastian Gibb. 2021. <em>Spectra: Spectra Infrastructure for Mass Spectrometry Data</em>. <a href="https://github.com/RforMassSpectrometry/Spectra">https://github.com/RforMassSpectrometry/Spectra</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Josep M. Badia.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
