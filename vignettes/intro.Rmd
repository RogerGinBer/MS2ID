---
title: "Introduction to MS2ID"
author: "Josep M. Badia"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to MS2ID}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Installation

You can download the development version from GitHub with:

```{r installation, eval = FALSE}
if(!requireNamespace("devtools", quietly = TRUE))
    install.packages("devtools")
devtools::install_github("jmbadia/MS2ID", build_vignettes = TRUE, force=T)
```

## Introduction
MS2ID aims to fast annotate query MS/MS spectra straightforwardly with minimum RAM requirements against public spectral libraries. With this in mind, MS2ID object keeps all data in a disk backend based on SQL and indexes all spectrum fragments in a table. Conceptually, MS2ID package is structured on three steps:   
1. **Creating an in-house MSn spectra library** as a *M2ID* object  
-- MS2IDdirectory <- createMS2ID(Mona, ...)
2. **Annotating MSn query spectra** against an MS2ID object, obtaining as a result an *Annot* object   
-- MS2IDobject <- MS2ID(MS2IDdirectory)    
-- AnnotObject <- annotate(querySpectra, MS2IDobject, ...)   
3. **Browsing the results** using the MS2ID GUI interface (based on Shiny)  
-- MS2IDgui(AnnotObject)    

## MS2ID creation
The createMS2ID() function takes as necessary argument MS/MS spectral data. This data can be obtained from publicly available resources such as HMDB, ChEBI and PubChem or any personal library by using the [CompoundDB package](https://euracbiomedicalresearch.github.io/CompoundDb/index.html), developed by Johannes Rainer and Jan Stanstrup.  Here we parse a small portion of MoNA (only 206 MS/MS spectra) following its [vignette](https://euracbiomedicalresearch.github.io/CompoundDb/articles/create-compounddb.html#create-a-compdb-object-for-mona-1).
```{r CompDbFormation, message=FALSE, cache=TRUE}
library(CompoundDb)
wrkDir <- tempdir()
## Locate the compounds file
MoNAsubset <- system.file("extdata/MoNAsubset.sdf.gz", package = "MS2ID")
cmps <- compound_tbl_sdf(MoNAsubset)
spctr <- msms_spectra_mona(MoNAsubset, collapsed = TRUE)
spctr$predicted <- FALSE
#configure metadata  
metad <- data.frame(
        name = c("source", "url", "source_version","source_date"),
        value = c("MoNA", "https://mona.fiehnlab.ucdavis.edu/downloads",
                  "v1", '07-09')
    )
#obtain compdb object
cmpdbDir <- file.path(wrkDir, "cmpdbDir")
if(dir.exists(cmpdbDir)){
  do.call(file.remove, list(list.files(cmpdbDir, full.names = TRUE)))
}else{
  dir.create(cmpdbDir)
}
db_file <- createCompDb(cmps, metadata = metad, msms_spectra = spctr,
                        path = cmpdbDir)
cmpdb <- CompDb(db_file)
```
Using the previous object as argument, the creation of the MS2ID object is pretty straightforward.  

```{r MS2IDcreation, eval=FALSE, message=FALSE}
library(MS2ID)
MS2IDdirectory <- createMS2ID(cmpdb = cmpdb, overwrite = TRUE,
                              path = wrkDir)
```
By default, createMS2ID() checks for redundant compounds or MS/MS spectra in the cmpdb object and removes them. Visit the help documentation for more information.  

## Annotation
A simple annotation only requires an MS2ID object like the former and query spectra. In the example following, query spectra are in mzML format (three mzML files, 2235 MS/MS spectra total), but the function also supports Spectra objects as input. By default, the annotation process summarizes query spectra into consensus spectra according to their similarity and neighbouring; this speeds up the algorithm and reduces the noise. Please, consult annotate help page for more information.

```{r SimpleAnnotation, eval = FALSE}
library(utils)
queryFile <- system.file("extdata/Met1.zip", package = "MS2ID")
queryFolder <- file.path(wrkDir, "QRYspectra")
utils::unzip(queryFile, exdir = queryFolder)
refLibrary <- MS2ID(MS2IDdirectory)
annotResult <- annotate(QRYdata = queryFolder, MS2ID = refLibrary)
```
The resulting variable (e.g. `annotResult`) is an Annot object (see [proper page](results.html)). This object stores the annotation results so we can extract particular content by applying them *getters* (custom functions to *get* the info) or save the whole object for further analysis (use saveRDS() and loadRDS()).  

Annotate function offers more features such as prefiltering of the reference spectra library or different similarity metrics. Please, feel free to check them in its own vignette.  

## Browsing the result
The annotation results can be browsed by using  

- The MS2Igui() function, which allows to compare graphically both query and reference spectra.
- The export2xlsx() function to export the annotation results to an excel file

```{r ms2idgui, eval = FALSE}
MS2IDgui(annotResult)
```

![MS2ID GUI interface](MS2IDgui.png){width=600px}  

Please note that using MS2IDgui() with no arguments pops up the interface with no annotation data. Visit the 'About' page in MS2IDGUI for more information.
